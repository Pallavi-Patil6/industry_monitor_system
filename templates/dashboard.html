<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced IoT Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #1976d2;
        --primary-light: #64b5f6;
        --secondary: #26a69a;
        --danger: #ef5350;
        --warning: #ffb74d;
        --success: #66bb6a;
        --light: #ffffff;
        --background: #f4f7fa;
        --text-dark: #2c3e50;
        --card-bg: #ffffff;
        --border-color: #e0e0e0;
      }

      body {
        background: var(--background);
        color: var(--text-dark);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 2px solid var(--border-color);
        flex-wrap: wrap;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo i {
        font-size: 2.5rem;
        color: var(--primary);
      }

      h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--light);
        padding: 10px 20px;
        border-radius: 50px;
        border: 1px solid var(--border-color);
      }

      .status-dot {
        width: 12px;
        height: 12px;
        background: var(--success);
        border-radius: 50%;
        animation: blink 1.5s infinite;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-top: 30px;
      }

      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-title i {
        font-size: 1.4rem;
        color: var(--primary);
      }

      .sensor-value {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        color: var(--primary);
      }

      .sensor-unit {
        font-size: 1.1rem;
        font-weight: 400;
        color: #666;
      }

      .sensor-status {
        text-align: center;
        font-size: 0.9rem;
        padding: 6px 14px;
        border-radius: 15px;
        display: inline-block;
        margin: 12px auto 0;
      }

      .status-normal {
        background: rgba(102, 187, 106, 0.15);
        color: var(--success);
      }

      .status-warning {
        background: rgba(255, 183, 77, 0.2);
        color: var(--warning);
      }

      .status-danger {
        background: rgba(239, 83, 80, 0.2);
        color: var(--danger);
      }

      .chart-container {
        height: 180px;
        margin-top: 15px;
      }

      .section-title {
        font-size: 1.6rem;
        margin: 40px 0 20px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .control-group {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid var(--border-color);
      }

      .control-title {
        font-size: 1.2rem;
        color: var(--text-dark);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .control-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-on {
        background: var(--success);
        color: #fff;
      }

      .btn-off {
        background: var(--danger);
        color: #fff;
      }

      .btn-led {
        background: var(--primary-light);
        flex: 1;
        color: white;
      }

      .leds-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 15px;
      }

      .device-card {
        background: #e3f2fd;
        padding: 10px 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
      }

      .led-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ccc;
      }

      .led-on {
        background: var(--success);
        box-shadow: 0 0 6px var(--success);
      }

      .buzzer-on {
        color: var(--danger);
        animation: pulse 1s infinite;
      }

      .alert-panel {
        background: #fff3f3;
        border: 1px solid var(--danger);
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
      }

      .alert-header {
        display: flex;
        align-items: center;
        color: var(--danger);
        font-size: 1.1rem;
        gap: 10px;
        margin-bottom: 10px;
      }

      .alert-list {
        list-style: none;
        padding-left: 0;
      }

      .alert-item {
        background: #ffecec;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 0.95rem;
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        .leds-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">
          <i class="fas fa-microchip"></i>
          <h1>Advanced IoT Dashboard</h1>
        </div>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span>Connected to IoT Hub</span>
        </div>
      </header>

      <div class="dashboard-grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-thermometer-half"></i>
              <span>Temperature</span>
            </div>
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="sensor-value" id="temp">
            --<span class="sensor-unit">Â°C</span>
          </div>
          <div class="sensor-status status-normal">Normal</div>
          <div class="chart-container">
            <canvas id="tempChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-tint"></i>
              <span>Humidity</span>
            </div>
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="sensor-value" id="humid">
            --<span class="sensor-unit">%</span>
          </div>
          <div class="sensor-status status-normal">Normal</div>
          <div class="chart-container">
            <canvas id="humidChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-wind"></i>
              <span>Gas Level</span>
            </div>
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="sensor-value" id="gas">--</div>
          <div class="sensor-status status-normal">Normal</div>
          <div class="chart-container">
            <canvas id="gasChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-sun"></i>
              <span>Light Level</span>
            </div>
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="sensor-value" id="ldr">
            --<span class="sensor-unit">lux</span>
          </div>
          <div class="sensor-status status-normal">Normal</div>
          <div class="chart-container">
            <canvas id="ldrChart"></canvas>
          </div>
        </div>
      </div>

      <div class="alert-panel">
        <div class="alert-header">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>System Alerts</h3>
        </div>
        <ul class="alert-list" id="alertList">
          <li class="alert-item">
            <i class="fas fa-info-circle"></i>
            <span>No active alerts. All systems normal.</span>
          </li>
        </ul>
      </div>

      <div class="controls-section">
        <h2 class="section-title">
          <i class="fas fa-sliders-h"></i>Device Controls
        </h2>

        <div class="controls-grid">
          <div class="control-group">
            <h3 class="control-title">
              <i class="fas fa-bell"></i> Buzzer Control
            </h3>
            <div class="control-buttons">
              <button
                class="btn btn-on"
                onclick="controlDevice('BUZZER', '', 1)"
              >
                <i class="fas fa-power-off"></i> Buzzer ON
              </button>
              <button
                class="btn btn-off"
                onclick="controlDevice('BUZZER', '', 0)"
              >
                <i class="fas fa-power-off"></i> Buzzer OFF
              </button>
            </div>
            <div class="device-status">
              <div class="device-card">
                <i class="fas fa-bell" id="buzzer-icon"></i>
                <span>Buzzer: <span id="buzzer-status">OFF</span></span>
              </div>
            </div>
          </div>

          <div class="control-group">
            <h3 class="control-title">
              <i class="fas fa-lightbulb"></i> LED Controls
            </h3>
            <div class="leds-grid">
              <div>
                <p>LED 0</p>
                <div class="control-buttons">
                  <button
                    class="btn btn-on btn-led"
                    onclick="controlDevice('LED', 0, 1)"
                  >
                    ON
                  </button>
                  <button
                    class="btn btn-off btn-led"
                    onclick="controlDevice('LED', 0, 0)"
                  >
                    OFF
                  </button>
                </div>
                <div class="device-card">
                  <div class="led-indicator" id="led0-indicator"></div>
                  <span>LED 0: <span id="led0-status">OFF</span></span>
                </div>
              </div>
              <div>
                <p>LED 1</p>
                <div class="control-buttons">
                  <button
                    class="btn btn-on btn-led"
                    onclick="controlDevice('LED', 1, 1)"
                  >
                    ON
                  </button>
                  <button
                    class="btn btn-off btn-led"
                    onclick="controlDevice('LED', 1, 0)"
                  >
                    OFF
                  </button>
                </div>
                <div class="device-card">
                  <div class="led-indicator" id="led1-indicator"></div>
                  <span>LED 1: <span id="led1-status">OFF</span></span>
                </div>
              </div>
              <div>
                <p>LED 2</p>
                <div class="control-buttons">
                  <button
                    class="btn btn-on btn-led"
                    onclick="controlDevice('LED', 2, 1)"
                  >
                    ON
                  </button>
                  <button
                    class="btn btn-off btn-led"
                    onclick="controlDevice('LED', 2, 0)"
                  >
                    OFF
                  </button>
                </div>
                <div class="device-card">
                  <div class="led-indicator" id="led2-indicator"></div>
                  <span>LED 2: <span id="led2-status">OFF</span></span>
                </div>
              </div>
              <div>
                <p>LED 3</p>
                <div class="control-buttons">
                  <button
                    class="btn btn-on btn-led"
                    onclick="controlDevice('LED', 3, 1)"
                  >
                    ON
                  </button>
                  <button
                    class="btn btn-off btn-led"
                    onclick="controlDevice('LED', 3, 0)"
                  >
                    OFF
                  </button>
                </div>
                <div class="device-card">
                  <div class="led-indicator" id="led3-indicator"></div>
                  <span>LED 3: <span id="led3-status">OFF</span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize charts
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
        },
        scales: {
          x: { display: false },
          y: { display: false },
        },
        elements: {
          point: { radius: 0 },
          line: {
            tension: 0.4,
            borderWidth: 2,
          },
        },
        animation: {
          duration: 0,
        },
      };

      const tempChart = new Chart(document.getElementById("tempChart"), {
        type: "line",
        data: {
          labels: Array(20).fill(""),
          datasets: [
            {
              data: Array(20).fill(0),
              borderColor: "#ff5252",
              backgroundColor: "rgba(255, 82, 82, 0.1)",
              fill: true,
            },
          ],
        },
        options: chartOptions,
      });

      const humidChart = new Chart(document.getElementById("humidChart"), {
        type: "line",
        data: {
          labels: Array(20).fill(""),
          datasets: [
            {
              data: Array(20).fill(0),
              borderColor: "#00bcd4",
              backgroundColor: "rgba(0, 188, 212, 0.1)",
              fill: true,
            },
          ],
        },
        options: chartOptions,
      });

      const gasChart = new Chart(document.getElementById("gasChart"), {
        type: "line",
        data: {
          labels: Array(20).fill(""),
          datasets: [
            {
              data: Array(20).fill(0),
              borderColor: "#ffc107",
              backgroundColor: "rgba(255, 193, 7, 0.1)",
              fill: true,
            },
          ],
        },
        options: chartOptions,
      });

      const ldrChart = new Chart(document.getElementById("ldrChart"), {
        type: "line",
        data: {
          labels: Array(20).fill(""),
          datasets: [
            {
              data: Array(20).fill(0),
              borderColor: "#b2ebf2",
              backgroundColor: "rgba(178, 235, 242, 0.1)",
              fill: true,
            },
          ],
        },
        options: chartOptions,
      });

      // Store historical data
      const tempData = Array(20).fill(0);
      const humidData = Array(20).fill(0);
      const gasData = Array(20).fill(0);
      const ldrData = Array(20).fill(0);

      // Device states
      const deviceStates = {
        BUZZER: 0,
        LED0: 0,
        LED1: 0,
        LED2: 0,
        LED3: 0,
      };

      // Alert thresholds
      const thresholds = {
        temp: { warning: 30, danger: 35 },
        humid: { warning: 70, danger: 85 },
        gas: { warning: 500, danger: 700 },
        ldr: { warning: 800, danger: 950 },
      };

      // Active alerts
      const activeAlerts = {};

      // Update chart with new data
      function updateChart(chart, dataArray, newValue) {
        dataArray.push(newValue);
        if (dataArray.length > 20) dataArray.shift();
        chart.data.datasets[0].data = dataArray;
        chart.update();
      }

      // Check for alerts
      function checkAlerts(sensor, value) {
        const thresholdsForSensor = thresholds[sensor];
        const alertList = document.getElementById("alertList");

        if (!thresholdsForSensor) return;

        let status = "status-normal";
        let statusText = "Normal";

        if (value >= thresholdsForSensor.danger) {
          status = "status-danger";
          statusText = "Danger!";

          // Add alert if not already present
          if (!activeAlerts[`${sensor}-danger`]) {
            activeAlerts[`${sensor}-danger`] = true;
            const alertItem = document.createElement("li");
            alertItem.className = "alert-item";
            alertItem.innerHTML = `<i class="fas fa-exclamation-circle"></i> 
          ${
            sensor.charAt(0).toUpperCase() + sensor.slice(1)
          } level critical (${value})`;
            alertList.prepend(alertItem);
          }
        } else if (value >= thresholdsForSensor.warning) {
          status = "status-warning";
          statusText = "Warning";

          // Add alert if not already present
          if (!activeAlerts[`${sensor}-warning`]) {
            activeAlerts[`${sensor}-warning`] = true;
            const alertItem = document.createElement("li");
            alertItem.className = "alert-item";
            alertItem.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 
          ${
            sensor.charAt(0).toUpperCase() + sensor.slice(1)
          } level high (${value})`;
            alertList.prepend(alertItem);
          }
        } else {
          // Remove alerts if they exist
          if (activeAlerts[`${sensor}-danger`]) {
            delete activeAlerts[`${sensor}-danger`];
          }
          if (activeAlerts[`${sensor}-warning`]) {
            delete activeAlerts[`${sensor}-warning`];
          }
        }

        // Update status display
        const statusElement = document
          .querySelector(`#${sensor}`)
          .closest(".card")
          .querySelector(".sensor-status");
        statusElement.className = "sensor-status " + status;
        statusElement.textContent = statusText;

        // Clear alerts if none
        if (Object.keys(activeAlerts).length === 0) {
          alertList.innerHTML = `<li class="alert-item"><i class="fas fa-info-circle"></i> No active alerts. All systems normal.</li>`;
        }
      }

      // Original fetchData function with enhancements
      function fetchData() {
        fetch("/get_data")
          .then((response) => response.json())
          .then((data) => {
            // Update dashboard with real data
            updateDashboard(data);
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
            // Update status indicator to show error
            document.querySelector(".status-dot").style.background =
              "var(--danger)";
            document.querySelector(".status-indicator span").textContent =
              "Connection Error";
          });
      }

      // Update dashboard with new data
      function updateDashboard(data) {
        // Temperature
        const tempElement = document.getElementById("temp");
        const prevTemp = parseFloat(tempElement.textContent) || 0;
        const newTemp = parseFloat(data.TEMP);
        tempElement.textContent = newTemp.toFixed(1);
        if (prevTemp !== 0 && Math.abs(prevTemp - newTemp) > 0.5) {
          tempElement.classList.add("value-change");
          setTimeout(() => tempElement.classList.remove("value-change"), 1000);
        }
        updateChart(tempChart, tempData, newTemp);
        checkAlerts("temp", newTemp);

        // Humidity
        const humidElement = document.getElementById("humid");
        const prevHumid = parseFloat(humidElement.textContent) || 0;
        const newHumid = parseFloat(data.HUMID);
        humidElement.textContent = newHumid.toFixed(1);
        if (prevHumid !== 0 && Math.abs(prevHumid - newHumid) > 1) {
          humidElement.classList.add("value-change");
          setTimeout(() => humidElement.classList.remove("value-change"), 1000);
        }
        updateChart(humidChart, humidData, newHumid);
        checkAlerts("humid", newHumid);

        // Gas
        const gasElement = document.getElementById("gas");
        const prevGas = parseFloat(gasElement.textContent) || 0;
        const newGas = parseFloat(data.GAS);
        gasElement.textContent = newGas;
        if (prevGas !== 0 && Math.abs(prevGas - newGas) > 20) {
          gasElement.classList.add("value-change");
          setTimeout(() => gasElement.classList.remove("value-change"), 1000);
        }
        updateChart(gasChart, gasData, newGas);
        checkAlerts("gas", newGas);

        // LDR
        const ldrElement = document.getElementById("ldr");
        const prevLdr = parseFloat(ldrElement.textContent) || 0;
        const newLdr = parseFloat(data.LDR);
        ldrElement.textContent = newLdr;
        if (prevLdr !== 0 && Math.abs(prevLdr - newLdr) > 30) {
          ldrElement.classList.add("value-change");
          setTimeout(() => ldrElement.classList.remove("value-change"), 1000);
        }
        updateChart(ldrChart, ldrData, newLdr);
        checkAlerts("ldr", newLdr);
      }

      // Original controlDevice function with UI enhancements
      function controlDevice(device, index, state) {
        // Update UI immediately for responsiveness
        updateDeviceUI(device, index, state);

        // Send the control command to the server
        fetch("/control", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ device, index, state }),
        })
          .then((response) => {
            if (!response.ok) {
              // If the command failed, revert the UI
              updateDeviceUI(
                device,
                index,
                deviceStates[device + index] ? 0 : 1
              );
              console.error("Control command failed");
            }
          })
          .catch((error) => {
            console.error("Error sending control command:", error);
            // Revert the UI on error
            updateDeviceUI(device, index, deviceStates[device + index] ? 0 : 1);
          });
      }

      // Update device UI based on state
      function updateDeviceUI(device, index, state) {
        const deviceKey = device + (index !== "" ? index : "");

        // Update device state
        deviceStates[deviceKey] = state;

        if (device === "BUZZER") {
          const buzzerIcon = document.getElementById("buzzer-icon");
          const buzzerStatus = document.getElementById("buzzer-status");

          if (state) {
            buzzerIcon.classList.add("buzzer-on");
            buzzerStatus.textContent = "ON";
            buzzerStatus.style.color = "var(--success)";
          } else {
            buzzerIcon.classList.remove("buzzer-on");
            buzzerStatus.textContent = "OFF";
            buzzerStatus.style.color = "";
          }
        } else if (device === "LED") {
          const ledIndicator = document.getElementById(`led${index}-indicator`);
          const ledStatus = document.getElementById(`led${index}-status`);

          if (state) {
            ledIndicator.classList.add("led-on");
            ledStatus.textContent = "ON";
            ledStatus.style.color = "var(--success)";
          } else {
            ledIndicator.classList.remove("led-on");
            ledStatus.textContent = "OFF";
            ledStatus.style.color = "";
          }
        }
      }

      // Initialize dashboard
      fetchData();

      // Fetch new data every second
      setInterval(fetchData, 1000);
    </script>
  </body>
</html>
